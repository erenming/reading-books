# 事务

- 认识事务
    1. 事务是区别于文件系统的重要特性之一，需满足ACID特性
    2. 主要目的：事务会把数据库从一种一致状态转换为另一种一种状态
    3. 原子性(Atomicity)
        - 原子性是指整个事务是不可分割的单位
        - 只有使事务中所有的数据库操作都执行成功，才算整个事务成功
        - 事务中任何一个SQL语句执行失败，已经执行的SQL语句也必须撤销，数据库状态应该回到执行事务前的状态
    4. 一致性(Consistency)
        - 一致性是指事务将数据库从一种状态转变为下一种一致的状态
        - 事务是一致性的单位，如果事务中某个动作失败了，系统可以自动撤销事务-返回初始化的状态
    5. 隔离性(Isolation)
        - 要求每个读写事务的对象对其他事务的操作对象能相互分离，即该事务提交前对其他事务都不可见
    6. 持久性(Durability)
        - 事务一旦提交，结果即为永久的
    7. 分类：
        - 扁平事务：最常用
        - 带保存点的扁平事务
        - 链事务
        - 嵌套事务
        - 分布式事务：通常在一个分布式环境下运行的扁平事务，因此需要根据数据所在位置访问网络中的不同节点
- 事务的实现
    1. `redo log`：重做日志，用来保证事务的原子性和持久性。实现"重做"操作
        - 由内存中的重做日志缓冲，易失的；重做日志文件，持久的；组成
        - 当事务提交(COMMIT)时，必须先将该事务的所有日志写入到重做日志文件进行持久化，待事务的COMMIT操作完成后才算完成
        - 通过`fsync`将日志缓冲写入日志文件
        - 保证事务的持久性
    2. `undo log`：用来保证事务的一致性。实现回滚操作
        - InnoDB会产生一定量的undo，这样如果用户执行的事务或语句失败了，又或者用户用一条ROLLBACK语句请求回滚，就可以利用undo信息将数据回滚到修改之前
    3. `purge`
        - delete和update操作可能并不直接删除原有数据，被“延迟”了，最终在purge操作中完成
    4. `group commit`
        - 为了提高磁盘fsync的效率，一次fsync可以刷新确保多个事务日志被写入文件
- 分布式事务: 指允许多个独立的事务资源参与到一个全局的事务中
    1. InnoDB使用`XA`来支持分布式事务的实现
    2. XA事务：由一个或多个资源管理器、一个事务管理器以及一个应用程序组成
        - 资源管理器：提供访问事务资源的方法。通常一个数据库就是一个资源管理器
        - 事务管理器：协调参与全局事务中的各个事务。需要和参与全局事务的所有资源管理器通信
        - 应用程序：定义事务的边界，指定全局事务的操作
        ![xx](https://raw.githubusercontent.com/erenming/reading-books/master/inside-mysql/images/WX20190510-170231@2x.png)
        - 使用两段式提交(two-phase commit)
            1. 第一阶段，所有参与全局事务的节点都开始准备(PREPARE)，告诉事务管理器它们准备好提交了
            2. 第二阶段，事务管理器告诉资源管理器执行ROLLBACK还是COMMIT
        - 与本地事务不同的是，分布式事务需要多一次PREPARE操作，待所有节点同意后，再进行后续操作
- 不好的事务习惯
    1. 在循环中提交：应最好整合成一个事务中，最后提交
    2. 使用自动提交：默认下是自动提交，需注意
    3. 使用自动回滚